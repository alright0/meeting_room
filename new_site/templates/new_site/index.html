{% extends 'new_site/base.html' %}
{% load custom_filters %}



{% block title %}Альфа.Совещания{% endblock %}


{% block content %}
<div class="rooms">
    {% for room in rooms %}
    <div class="room" id="room_{{ room.id }}">
        <h1><a href="/rooms/{{room.id}}">{{ room.name }}</a></h1>
        <p><b>Мест:</b> {{room.seats}}</p>
        <p>{{ schedule|get_item:room.id }}</p>
        {% if room.board %}
        <div class="description_image-board">
            <img src="../../static/img/board.png">
        </div>
        {% endif %}
        {% if room.projector %}
        <div class="description_image-projector">
            <img src="../../static/img/projector.png">
        </div>
        {% endif %}
    </div>
    {% endfor %}

    {% if request.user|has_group:"manager" %}
    <div class="add_room">
        <a href="/addroom"><input type="button" class="add" value="+ Добавить комнату"></a>
    </div>
    <div class="spacer"></div>
    <div class="meetings"></div>

    <script>
        // обновление списка встречь с заданным интервалом
        var seconds = 10;
        var timeout = 1000 * seconds;
        const csrftoken = document.getElementsByName('csrfmiddlewaretoken').item(0).value

        // первый вызов при загрузке
        update_meetings({{ user.id }}, csrftoken);

        setTimeout(function run_update_meetings() {
            update_meetings({{ user.id }}, csrftoken);
        setTimeout(run_update_meetings, timeout);
    }, timeout);
    </script>

    <script>

        // функция подтверждения/отклонения встречь, вызывается нажатием кнопок подтвердить/отклонить
        function send_meeting_answer(answer, elem) {

            // создание html-заглушки на месте встречи после подтверждения/отклонения
            create_html_answer(answer, elem)
            interval_seconds = 1

            // запрос на сервер об обновлении списка записей
            var answ = setTimeout(function () {
                $.ajax({
                    type: "post",
                    data: { "answer": answer, "meeting_id": elem, "csrfmiddlewaretoken": csrftoken },
                    success: function (response) {
                        console.log(response)

                        //сокет на отправку уведомлений пользователям
                        const ws_to_organizator = new WebSocket(`ws://${window.location.host}/user/${response.organizator_id}/`)

                        var check_socket_ready = function (data) {
                            if (!ws_to_organizator.readyState) {
                                setTimeout(function () {
                                    check_socket_ready(data);
                                }, 100);
                            } else {
                                ws_to_organizator.send(data)
                                ws_to_organizator.close()
                            }
                        };
                        check_socket_ready(JSON.stringify({ "meeting_id": elem, "answer": answer }));
                        update_meetings({{ user.id }}, csrftoken);
            },
                })
                }, 1000 * interval_seconds);}


    </script>

    {% endif %}
</div>

{% endblock %}